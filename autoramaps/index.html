<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Autoramaps</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts para um visual de game -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background-color: #000;
        }

        /* Efeito H√≠brido Suavizado: Sat√©lite noturno reconhec√≠vel */
        .leaflet-tile {
            filter: grayscale(40%) brightness(0.65) contrast(1.2) hue-rotate(180deg);
        }

        /* Linha de Partida/Chegada */
        .start-line {
            background: repeating-linear-gradient(90deg, #fff 0px, #fff 4px, #000 4px, #000 8px);
            border: 1px solid #00f3ff;
            box-shadow: 0 0 10px #00f3ff;
            width: 100%;
            height: 100%;
        }

        /* Efeito Glow (Brilho Neon) na linha da pista */
        path.leaflet-interactive {
            filter: drop-shadow(0 0 4px #00f3ff) drop-shadow(0 0 12px #00f3ff);
        }

        /* Overlay da Interface do Jogo */
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .title {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: #00f3ff;
            font-size: 28px;
            font-weight: 900;
            text-shadow: 0 0 10px #00f3ff, 0 0 20px #00f3ff;
            pointer-events: none;
            letter-spacing: 2px;
            text-align: center;
        }

        /* HUD Superior (Agora em linha e deslocado do t√≠tulo) */
        .hud-top {
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.5), transparent);
            padding: 60px 20px 20px 20px; /* Margem superior para respeitar o t√≠tulo */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: auto;
        }

        .stats-panel {
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #00f3ff;
            border-radius: 10px;
            padding: 10px 20px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            display: flex;
            flex-direction: row; /* Modificado para alinhar em linha */
            flex-wrap: wrap;
            gap: 25px;
            align-items: center;
        }

        .stat-line {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 10px;
            color: #00f3ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 20px;
            color: #fff;
            font-weight: 700;
            text-shadow: 0 0 5px #fff;
            font-variant-numeric: tabular-nums;
        }

        #pause-btn {
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #00f3ff;
            color: #00f3ff;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        #pause-btn:active {
            background: #00f3ff;
            color: #000;
        }

        /* Controle Deslizante (Slider HORIZONTAL / Gatilho Inferior) */
        #controller-area {
            position: absolute;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            width: 70vw;
            max-width: 500px;
            height: 70px;
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #00f3ff;
            border-radius: 35px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.4), inset 0 0 20px #000;
            pointer-events: auto;
            display: flex;
            align-items: center;
        }

        #controller-area::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 20px;
            right: 20px;
            height: 6px;
            background: #004466;
            border-radius: 3px;
            transform: translateY(-50%);
            z-index: 1;
        }

        #slider-thumb {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 70px;
            height: 50px;
            background: linear-gradient(to bottom, #00ff00, #009900);
            border-radius: 25px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.8), inset 2px 0 10px rgba(255,255,255,0.4);
            cursor: pointer;
            z-index: 2;
            transition: left 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Voltar para a esquerda */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #slider-thumb::after {
            content: '‚ñ∂';
            color: rgba(0,0,0,0.5);
            font-size: 24px;
            margin-left: 2px;
        }

        #slider-thumb.dragging {
            transition: none;
            background: linear-gradient(to bottom, #00ffcc, #00aa88);
            box-shadow: 0 0 20px #00ffcc, inset 2px 0 10px rgba(255,255,255,0.6);
        }

        /* Sem√°foro de Largada */
        #semaforo-screen {
            position: absolute;
            top: 30%; left: 50%; transform: translate(-50%, -50%);
            display: none; flex-direction: row; gap: 20px;
            background: rgba(0, 0, 0, 0.8); padding: 20px;
            border-radius: 20px; border: 3px solid #333;
            z-index: 150; pointer-events: none;
        }

        .luz {
            width: 60px; height: 60px; border-radius: 50%;
            background: #222; border: 2px solid #111;
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.8); transition: all 0.2s;
        }

        .luz.red-on { background: #ff0000; box-shadow: 0 0 30px #ff0000, inset 0 5px 10px rgba(255,255,255,0.4); }
        .luz.green-on { background: #00ff00; box-shadow: 0 0 40px #00ff00, inset 0 5px 10px rgba(255,255,255,0.6); }

        /* Telas de Informa√ß√£o / Loading / Resultados */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: opacity 0.5s;
        }

        #loading-screen h2 {
            color: #00f3ff; font-size: 24px; text-shadow: 0 0 10px #00f3ff;
            animation: pulse 1s infinite alternate; text-align: center; padding: 20px;
        }

        @keyframes pulse { from { opacity: 0.5; } to { opacity: 1; } }

        #menu-screen, #results-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 15, 0.95); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }

        #menu-screen.visible, #results-screen.visible { opacity: 1; pointer-events: auto; }

        .menu-box {
            background: rgba(0, 20, 40, 0.9); border: 2px solid #00f3ff;
            padding: 40px; border-radius: 15px; text-align: center;
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.2);
            display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 450px;
            max-height: 90vh; overflow-y: auto;
        }

        .menu-box select, .menu-box input[type="text"], .menu-box input[type="number"] {
            width: 100%; padding: 12px; background: #000; color: #00f3ff;
            border: 1px solid #00f3ff; font-family: 'Orbitron', sans-serif;
            font-size: 16px; outline: none; border-radius: 5px; margin-bottom: 5px;
        }

        .menu-box label { text-align: left; margin-bottom: -10px; }

        .menu-btn {
            padding: 15px 30px; background: linear-gradient(to right, #0055ff, #00aaff);
            border: none; color: white; font-family: 'Orbitron', sans-serif;
            font-weight: bold; font-size: 16px; cursor: pointer; border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.4); transition: transform 0.1s; text-transform: uppercase;
        }
        .menu-btn:active { transform: scale(0.95); }

        .res-highlight { color: #00f3ff; font-weight: bold; font-size: 22px; margin-left: 10px; }

        /* --- CARRO E HUD RADIAL --- */
        .car-container {
            width: 30px; height: 14px; display: flex; align-items: center;
            justify-content: center; position: relative;
        }
        
        #car-body {
            width: 30px; height: 14px; background: #ff0055;
            border-radius: 4px; border: 2px solid #fff;
            box-shadow: 0 0 10px #ff0055; position: relative; z-index: 2;
        }
        
        #car-body::before, #car-body::after {
            content: ''; position: absolute; right: 0; width: 4px; height: 3px;
            background: #fff; box-shadow: 5px 0 10px #fff; border-radius: 50%;
        }
        #car-body::before { top: 1px; } #car-body::after { bottom: 1px; }

        #car-hud {
            position: absolute; left: -40px; top: -18px; width: 50px; height: 50px; z-index: 1;
        }

        #hud-speed-text {
            position: absolute; top: 20px; left: -12px; width: 30px; text-align: center;
            color: #fff; font-size: 11px; font-weight: 900;
            text-shadow: 0 0 4px #000, 0 0 8px #00f3ff;
        }

        /* --- EFEITOS MACH 1 --- */
        .sonic-boom {
            position: absolute; width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(0,243,255,0.8) 40%, rgba(0,0,0,0) 70%);
            border-radius: 50%; transform: translate(-50%, -50%) scale(0.1);
            animation: boom-expand 0.6s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
            pointer-events: none; mix-blend-mode: screen; z-index: 5;
        }

        @keyframes boom-expand { to { transform: translate(-50%, -50%) scale(10); opacity: 0; } }

        @keyframes sonic-shake {
            0% { margin-top: 0px; margin-left: 0px; } 25% { margin-top: 2px; margin-left: 2px; }
            50% { margin-top: -2px; margin-left: 0px; } 75% { margin-top: 0px; margin-left: -2px; }
            100% { margin-top: -2px; margin-left: 2px; }
        }

        .supersonic-car #car-body {
            animation: sonic-shake 0.05s infinite !important;
            box-shadow: -15px 0 20px #00f3ff, -35px 0 40px #ff0055, 0 0 15px #fff !important;
            background: #fff !important; border-color: #00f3ff !important;
        }

        @media (max-width: 600px) {
            .hud-top { flex-direction: column; align-items: stretch; gap: 10px; padding-top: 60px; }
            .stats-panel { justify-content: space-around; gap: 10px; }
            #controller-area { width: 90vw; height: 60px; bottom: 15px; }
            #slider-thumb { width: 60px; height: 40px; }
            .luz { width: 40px; height: 40px; }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="game-ui">
        <div class="title">AUTORAMAPS</div>
        <div class="hud-top">
            <div class="stats-panel">
                <div class="stat-line">
                    <span class="stat-label">Tempo</span>
                    <span class="stat-value" id="time-display">00:00.000</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">Melhor Volta</span>
                    <span class="stat-value" id="best-time-display" style="color: #00f3ff; opacity: 0.8;">--:--.---</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">Volta</span>
                    <span class="stat-value" id="lap-display">1 / 3</span>
                </div>
            </div>
            <button id="pause-btn">|| PAUSE</button>
        </div>

        <!-- Controlador Horizontal -->
        <div id="controller-area">
            <div id="slider-thumb"></div>
        </div>
    </div>

    <div id="semaforo-screen">
        <div class="luz" id="luz-1"></div>
        <div class="luz" id="luz-2"></div>
        <div class="luz" id="luz-3"></div>
    </div>

    <!-- Ecr√£ de Resultados (Fim da Corrida) -->
    <div id="results-screen">
        <div class="menu-box">
            <h1 style="color: #00ff00; font-size: 32px; text-shadow: 0 0 15px #00ff00; margin: 0;">üèÅ FIM DA CORRIDA! üèÅ</h1>
            <p style="color: #fff; font-size: 18px;">Voltas Conclu√≠das: <span id="res-laps" class="res-highlight"></span></p>
            <p style="color: #fff; font-size: 18px;">Melhor Volta: <span id="res-best-lap" class="res-highlight"></span></p>
            <p style="color: #fff; font-size: 18px;">Tempo Total: <span id="res-total-time" class="res-highlight" style="color: #00ff00;"></span></p>
            <button class="menu-btn" id="res-menu-btn" style="margin-top: 15px;">VOLTAR AO MENU</button>
        </div>
    </div>

    <div id="loading-screen" style="display: none; opacity: 0;">
        <h2>GPS: A Mapear Ruas e a Gerar Circuito...</h2>
    </div>

    <div id="menu-screen" class="visible">
        <div class="menu-box">
            <h1 style="color: #00f3ff; font-size: 38px; text-shadow: 0 0 20px #00f3ff; margin: 0; text-align: center; letter-spacing: 2px;">AUTORAMAPS</h1>
            
            <label for="location-select" style="color: #fff; font-size: 12px; letter-spacing: 1px; margin-top: 10px;">ESCOLHA UM LUGAR FAMOSO:</label>
            <select id="location-select">
                <option value="-23.5855,-46.6595">Parque Ibirapuera, SP</option>
                <option value="-23.5615,-46.6560">Av. Paulista, SP</option>
                <option value="-22.9711,-43.1822">Copacabana, RJ</option>
                <option value="-15.7938,-47.8827">Esplanada, Bras√≠lia</option>
                <option value="40.7580,-73.9855">Times Square, NY</option>
                <option value="35.6595,139.7005">Shibuya, T√≥quio</option>
                <option value="48.8738,2.2950">Arco do Triunfo, Paris</option>
            </select>
            
            <label for="custom-address" style="color: #fff; font-size: 12px; letter-spacing: 1px;">OU DIGITE O SEU ENDERE√áO:</label>
            <input type="text" id="custom-address" placeholder="Ex: Av. Paulista, 1000, S√£o Paulo">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label for="custom-radius" style="color: #fff; font-size: 12px; letter-spacing: 1px;">RAIO DO CIRCUITO (KM):</label>
                    <input type="number" id="custom-radius" value="1.2" step="0.1" min="0.1">
                </div>
                <div style="flex: 1;">
                    <label for="custom-laps" style="color: #fff; font-size: 12px; letter-spacing: 1px;">N¬∫ DE VOLTAS:</label>
                    <input type="number" id="custom-laps" value="3" min="1">
                </div>
            </div>

            <div id="menu-error" style="color: #ff0055; font-size: 14px; font-weight: bold; display: none;"></div>

            <button class="menu-btn" id="menu-start-btn">GERAR PISTA & INICIAR</button>
            <button class="menu-btn" id="menu-resume-btn" style="display: none; background: linear-gradient(to right, #00cc00, #008800); box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);">RETOMAR CORRIDA</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURA√á√ïES EXTREMAS (MACH 1) ---
        const MAX_SPEED = 700; 
        const ACCELERATION_MAX = 250; 
        const FRICTION = 10; 
        const BRAKE_FRICTION = 250; 
        const MAX_GRIP = 2500; 
        const CAMERA_ZOOM = 19.2; 

        // --- INICIALIZA√á√ÉO DO MAPA ---
        const map = L.map('map', {
            zoomControl: false, dragging: false, touchZoom: false, doubleClickZoom: false,
            scrollWheelZoom: false, boxZoom: false, keyboard: false, zoomSnap: 0.1 
        });

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 20
        }).addTo(map);

        // --- VARI√ÅVEIS GLOBAIS ---
        let polyline = null; let carMarker = null; let startLineMarker = null;
        let carWrapperElement = null; let hudSpeedElement = null; let hudRpmBar = null;
        let trackSegments = []; let totalTrackDistance = 0;

        const state = {
            distance: 0, speed: 0, throttle: 0, laps: 1, totalLaps: 3, 
            lapTime: 0, totalRaceTime: 0, bestLap: Infinity,
            isSpinning: false, spinTimer: 0, currentAngleVisual: 0,
            gameStarted: false, isPaused: true, inCountdown: false, raceFinished: false,
            camLat: null, camLng: null, lookAheadLat: 0, lookAheadLng: 0, mach1: false
        };

        const lapDisplay = document.getElementById('lap-display');
        const timeDisplay = document.getElementById('time-display');
        const bestTimeDisplay = document.getElementById('best-time-display');
        
        const menuScreen = document.getElementById('menu-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('menu-start-btn');
        const resumeBtn = document.getElementById('menu-resume-btn');
        const resMenuBtn = document.getElementById('res-menu-btn');
        const locationSelect = document.getElementById('location-select');
        const pauseBtn = document.getElementById('pause-btn');
        
        const controllerArea = document.getElementById('controller-area');
        const sliderThumb = document.getElementById('slider-thumb');
        
        const semaforoScreen = document.getElementById('semaforo-screen');
        const luz1 = document.getElementById('luz-1');
        const luz2 = document.getElementById('luz-2');
        const luz3 = document.getElementById('luz-3');

        function formatLapTime(ms) {
            if (ms === 0 || ms === Infinity) return "--:--.---";
            let date = new Date(Math.max(0, ms));
            let m = String(date.getUTCMinutes()).padStart(2, '0');
            let s = String(date.getUTCSeconds()).padStart(2, '0');
            let mil = String(date.getUTCMilliseconds()).padStart(3, '0');
            return `${m}:${s}.${mil}`;
        }

        pauseBtn.addEventListener('click', () => {
            if (!state.gameStarted || state.inCountdown || state.raceFinished) return;
            state.isPaused = true;
            resetThrottle();
            menuScreen.classList.add('visible');
            resumeBtn.style.display = 'block';
            startBtn.innerText = 'GERAR NOVO CIRCUITO';
        });

        resumeBtn.addEventListener('click', () => {
            state.isPaused = false;
            menuScreen.classList.remove('visible');
        });

        resMenuBtn.addEventListener('click', () => {
            resultsScreen.classList.remove('visible');
            menuScreen.classList.add('visible');
            resumeBtn.style.display = 'none';
            startBtn.innerText = 'GERAR PISTA & INICIAR';
        });

        startBtn.addEventListener('click', async () => {
            const errorMsg = document.getElementById('menu-error');
            errorMsg.style.display = 'none';

            const radiusInput = document.getElementById('custom-radius').value;
            const radiusKm = parseFloat(radiusInput) || 1.2;
            const lapsInput = document.getElementById('custom-laps').value;
            const totalLaps = parseInt(lapsInput) || 3;

            if (radiusKm <= 0 || totalLaps <= 0) {
                errorMsg.innerText = "Valores inv√°lidos. Verifique o raio e voltas.";
                errorMsg.style.display = 'block'; return;
            }

            const customAddress = document.getElementById('custom-address').value.trim();
            let lat, lng;

            menuScreen.classList.remove('visible');
            const loadingScreen = document.getElementById('loading-screen');
            const loadingTitle = loadingScreen.querySelector('h2');
            loadingScreen.style.display = 'flex'; loadingScreen.style.opacity = '1';

            if (customAddress !== "") {
                loadingTitle.innerText = "GPS: A procurar endere√ßo...";
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(customAddress)}`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        lat = parseFloat(data[0].lat); lng = parseFloat(data[0].lon);
                    } else { throw new Error("Endere√ßo n√£o encontrado."); }
                } catch (e) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        menuScreen.classList.add('visible');
                        errorMsg.innerText = "Endere√ßo n√£o encontrado! Tente adicionar cidade ou pa√≠s.";
                        errorMsg.style.display = 'block';
                    }, 500);
                    return;
                }
            } else {
                [lat, lng] = locationSelect.value.split(',').map(Number);
            }
            
            loadingTitle.innerText = "GPS: A mapear ruas e a gerar circuito...";
            initGame(lat, lng, radiusKm, totalLaps);
        });

        async function initGame(centerLat, centerLng, radiusKm, totalLaps) {
            if (polyline) map.removeLayer(polyline);
            if (carMarker) map.removeLayer(carMarker);
            if (startLineMarker) map.removeLayer(startLineMarker);
            
            state.distance = 0; state.speed = 0; state.laps = 1; state.totalLaps = totalLaps; 
            state.lapTime = 0; state.totalRaceTime = 0; state.bestLap = Infinity; 
            state.isSpinning = false; state.currentAngleVisual = 0; state.raceFinished = false;
            state.gameStarted = false; state.isPaused = true; state.camLat = null; state.camLng = null;
            state.lookAheadLat = 0; state.lookAheadLng = 0; state.mach1 = false;
            resetThrottle();
            
            lapDisplay.innerText = `${state.laps} / ${state.totalLaps}`;
            timeDisplay.innerText = "00:00.000";
            bestTimeDisplay.innerText = "--:--.---";
            resultsScreen.classList.remove('visible');

            const numPoints = 4;
            const radius = radiusKm / 111; 
            let waypoints = [];
            for(let i = 0; i < numPoints; i++) {
                const angle = (i / numPoints) * Math.PI * 2;
                const r = radius * (0.6 + Math.random() * 0.4); 
                const lat = centerLat + r * Math.cos(angle);
                const lng = centerLng + r * Math.sin(angle);
                waypoints.push(`${lng},${lat}`);
            }
            waypoints.push(waypoints[0]);

            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${waypoints.join(';')}?geometries=geojson&overview=full`;
            let trackPoints = [];
            
            try {
                const response = await fetch(osrmUrl);
                const data = await response.json();
                if(data.routes && data.routes.length > 0) {
                    trackPoints = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                } else { throw new Error("Rota n√£o encontrada"); }
            } catch (error) {
                for (let t = 0; t <= Math.PI * 2; t += 0.1) {
                    trackPoints.push([centerLat + 0.01 * Math.cos(t), centerLng + 0.01 * Math.sin(t)]);
                }
            }

            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 500);

            polyline = L.polyline(trackPoints, { color: '#00f3ff', weight: 3, opacity: 0.9, lineJoin: 'round' }).addTo(map);
            map.fitBounds(polyline.getBounds(), { padding: [50, 50] });

            trackSegments = []; totalTrackDistance = 0;

            for (let i = 0; i < trackPoints.length - 1; i++) {
                let p1 = L.latLng(trackPoints[i]); let p2 = L.latLng(trackPoints[i+1]);
                let dist = p1.distanceTo(p2); 
                let dy = p1.lat - p2.lat; let dx = p2.lng - p1.lng;
                
                trackSegments.push({
                    length: dist, angle: Math.atan2(dy, dx),
                    lat1: p1.lat, lng1: p1.lng, lat2: p2.lat, lng2: p2.lng
                });
                totalTrackDistance += dist;
            }

            for (let i = 0; i < trackSegments.length; i++) {
                let prevSeg = trackSegments[(i - 1 + trackSegments.length) % trackSegments.length];
                let angleDiff = trackSegments[i].angle - prevSeg.angle;
                angleDiff = Math.atan2(Math.sin(angleDiff), Math.cos(angleDiff));
                trackSegments[i].danger = Math.abs(angleDiff) / (trackSegments[i].length + 1); 
            }

            // --- INSER√á√ÉO DA LINHA DE LARGADA ---
            let startAngleDeg = trackSegments[0].angle * (180 / Math.PI);
            const startLineIcon = L.divIcon({
                html: `<div class="start-line" style="transform: rotate(${startAngleDeg + 90}deg);"></div>`,
                className: '', iconSize: [8, 60], iconAnchor: [4, 30]
            });
            startLineMarker = L.marker(trackPoints[0], {icon: startLineIcon}).addTo(map);

            // --- INSER√á√ÉO DO CARRO + HUD RADIAL ---
            const carIcon = L.divIcon({
                html: `
                    <div class="car-container" id="car-wrapper">
                        <div id="car-hud">
                            <svg viewBox="0 0 50 50" style="width: 100%; height: 100%; drop-shadow: 0 0 5px #00f3ff;">
                                <path d="M 35 5 A 20 20 0 0 0 35 45" fill="none" stroke="rgba(0,243,255,0.2)" stroke-width="6" stroke-linecap="round"/>
                                <path id="hud-rpm-bar" d="M 35 5 A 20 20 0 0 0 35 45" fill="none" stroke="#00f3ff" stroke-width="6" stroke-linecap="round" stroke-dasharray="62.8" stroke-dashoffset="62.8"/>
                            </svg>
                            <div id="hud-speed-text">0</div>
                        </div>
                        <div id="car-body"></div>
                    </div>
                `,
                className: '', iconSize: [30, 14], iconAnchor: [15, 7]
            });

            carMarker = L.marker(trackPoints[0], {icon: carIcon}).addTo(map);
            carWrapperElement = null; hudSpeedElement = null; hudRpmBar = null;

            state.currentAngleVisual = trackSegments.length > 0 ? trackSegments[0].angle : 0;
            runCountdown(trackPoints[0][0], trackPoints[0][1]);
        }

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        async function runCountdown(startLat, startLng) {
            state.inCountdown = true;
            luz1.className = 'luz'; luz2.className = 'luz'; luz3.className = 'luz';
            semaforoScreen.style.display = 'flex';

            await sleep(1000); 
            luz1.classList.add('red-on'); await sleep(1000);
            luz2.classList.add('red-on');
            map.flyTo([startLat, startLng], CAMERA_ZOOM, { duration: 2.0, easeLinearity: 0.25 });
            
            await sleep(2000); 
            luz1.classList.remove('red-on'); luz2.classList.remove('red-on'); luz3.classList.add('green-on');
            
            state.inCountdown = false; state.gameStarted = true; state.isPaused = false;
            await sleep(1000); semaforoScreen.style.display = 'none';
        }

        // --- CONTROLO HORIZONTAL ---
        let isDragging = false;
        function resetThrottle() {
            state.throttle = 0; sliderThumb.style.left = '10px'; sliderThumb.classList.remove('dragging');
        }
        function handlePointerDown(e) {
            if (!state.gameStarted || state.isPaused || state.isSpinning || state.raceFinished) return;
            isDragging = true; sliderThumb.classList.add('dragging'); 
            updateThrottle(e.clientX || e.touches[0].clientX);
        }
        function handlePointerMove(e) {
            if (!isDragging) return; if (e.cancelable) e.preventDefault(); 
            updateThrottle(e.clientX || (e.touches ? e.touches[0].clientX : 0));
        }
        function handlePointerUp() { isDragging = false; resetThrottle(); }
        
        function updateThrottle(clientX) {
            const rect = controllerArea.getBoundingClientRect();
            const trackWidth = rect.width - 90; // Respeita a largura do thumb e padding interior
            let x = clientX - rect.left - 45; // Centro do gatilho
            x = Math.max(0, Math.min(x, trackWidth));
            state.throttle = x / trackWidth; 
            sliderThumb.style.left = (x + 10) + 'px';
        }

        controllerArea.addEventListener('mousedown', handlePointerDown);
        window.addEventListener('mousemove', handlePointerMove); 
        window.addEventListener('mouseup', handlePointerUp);
        controllerArea.addEventListener('touchstart', handlePointerDown, {passive: false});
        window.addEventListener('touchmove', handlePointerMove, {passive: false});
        window.addEventListener('touchend', handlePointerUp); 
        window.addEventListener('touchcancel', handlePointerUp);

        // --- LOOP PRINCIPAL DO JOGO ---
        let lastTime = 0;

        function update(time) {
            if (!lastTime) lastTime = time;
            let dt = (time - lastTime) / 1000;
            lastTime = time;
            
            if (dt > 0.1) dt = 0.1; 

            if (state.isPaused || !state.gameStarted) {
                requestAnimationFrame(update); return;
            }

            if (!carWrapperElement) {
                carWrapperElement = document.getElementById('car-wrapper');
                hudSpeedElement = document.getElementById('hud-speed-text');
                hudRpmBar = document.getElementById('hud-rpm-bar');
            }

            if (!state.inCountdown && !state.raceFinished) {
                state.lapTime += dt * 1000;
                state.totalRaceTime += dt * 1000;
                timeDisplay.innerText = formatLapTime(state.lapTime);
            }

            if (state.isSpinning) {
                state.spinTimer += dt;
                state.spinVelocity -= FRICTION * 2 * dt; 
                state.spinVelocity = Math.max(0, state.spinVelocity);

                state.spinLat += state.spinDirLat * state.spinVelocity * dt;
                state.spinLng += state.spinDirLng * state.spinVelocity * dt;

                carMarker.setLatLng([state.spinLat, state.spinLng]);

                let lookAheadMeters = (state.speed / MAX_SPEED) * 120;
                let targetOffsetLat = state.spinDirLat * lookAheadMeters;
                let targetOffsetLng = state.spinDirLng * lookAheadMeters;
                
                state.lookAheadLat += (targetOffsetLat - state.lookAheadLat) * dt * 2.5;
                state.lookAheadLng += (targetOffsetLng - state.lookAheadLng) * dt * 2.5;

                state.camLat = state.spinLat + state.lookAheadLat;
                state.camLng = state.spinLng + state.lookAheadLng;

                map.setView([state.camLat, state.camLng], CAMERA_ZOOM, {animate: false});

                state.currentAngleVisual += dt * 25; 
                if (carWrapperElement) {
                    let deg = state.currentAngleVisual * (180 / Math.PI);
                    carWrapperElement.style.transform = `rotate(${deg}deg)`;
                }

                if (state.spinTimer > 1.2) { 
                    state.isSpinning = false; state.speed = 0;
                }
            } else {
                if (state.throttle > 0 && !state.raceFinished) {
                    state.speed += (ACCELERATION_MAX * state.throttle - FRICTION) * dt;
                } else {
                    state.speed -= BRAKE_FRICTION * dt;
                }
                
                state.speed = Math.max(0, Math.min(state.speed, MAX_SPEED));
                state.distance += state.speed * dt;

                // --- L√ìGICA DE VOLTAS E FIM DE CORRIDA ---
                if (state.distance >= totalTrackDistance) {
                    state.distance = state.distance % totalTrackDistance;
                    
                    if (state.lapTime < state.bestLap && state.lapTime > 1000) {
                        state.bestLap = state.lapTime;
                        bestTimeDisplay.innerText = formatLapTime(state.bestLap);
                    }

                    state.laps++; 
                    if (state.laps > state.totalLaps) {
                        // Termina a Corrida
                        state.raceFinished = true;
                        state.isPaused = true;
                        resetThrottle();
                        
                        document.getElementById('res-laps').innerText = state.totalLaps;
                        document.getElementById('res-best-lap').innerText = formatLapTime(state.bestLap);
                        document.getElementById('res-total-time').innerText = formatLapTime(state.totalRaceTime);
                        resultsScreen.classList.add('visible');
                    } else {
                        lapDisplay.innerText = `${state.laps} / ${state.totalLaps}`;
                        state.lapTime = 0; 
                    }
                }

                let currDist = state.distance; let segIdx = 0;
                while (currDist > trackSegments[segIdx].length && segIdx < trackSegments.length - 1) {
                    currDist -= trackSegments[segIdx].length; segIdx++;
                }

                let segment = trackSegments[segIdx];
                let ratio = segment.length > 0 ? currDist / segment.length : 0;

                let currentLat = segment.lat1 + (segment.lat2 - segment.lat1) * ratio;
                let currentLng = segment.lng1 + (segment.lng2 - segment.lng1) * ratio;

                carMarker.setLatLng([currentLat, currentLng]);

                let fwdLat = segment.length > 0 ? (segment.lat2 - segment.lat1) / segment.length : 0;
                let fwdLng = segment.length > 0 ? (segment.lng2 - segment.lng1) / segment.length : 0;
                
                let lookAheadMeters = (state.speed / MAX_SPEED) * 120; 
                let targetOffsetLat = fwdLat * lookAheadMeters;
                let targetOffsetLng = fwdLng * lookAheadMeters;

                state.lookAheadLat += (targetOffsetLat - state.lookAheadLat) * dt * 2.5;
                state.lookAheadLng += (targetOffsetLng - state.lookAheadLng) * dt * 2.5;

                state.camLat = currentLat + state.lookAheadLat;
                state.camLng = currentLng + state.lookAheadLng;

                map.setView([state.camLat, state.camLng], CAMERA_ZOOM, {animate: false});

                let centrifugalForce = (state.speed * Math.sqrt(state.speed)) * segment.danger;

                if (centrifugalForce > MAX_GRIP && state.speed > 15 && !state.raceFinished) {
                    state.isSpinning = true; state.spinTimer = 0; state.spinVelocity = state.speed * 0.7; 
                    state.spinDirLat = fwdLat; state.spinDirLng = fwdLng;
                    state.spinLat = currentLat; state.spinLng = currentLng;
                    isDragging = false; resetThrottle();
                }

                if (carWrapperElement && !state.isSpinning) {
                    let targetAngle = segment.angle; 
                    let diff = targetAngle - state.currentAngleVisual;
                    diff = Math.atan2(Math.sin(diff), Math.cos(diff)); 
                    
                    state.currentAngleVisual += diff * (dt * 20);
                    let deg = state.currentAngleVisual * (180 / Math.PI);
                    carWrapperElement.style.transform = `rotate(${deg}deg)`;

                    if (hudSpeedElement) {
                        hudSpeedElement.style.transform = `rotate(${-deg}deg)`;
                    }
                }
            }

            let kmh = state.isSpinning ? 0 : Math.round(state.speed * 2.04);
            
            if (hudSpeedElement && hudRpmBar) {
                hudSpeedElement.innerText = kmh;
                let fillPct = state.speed / MAX_SPEED;
                hudRpmBar.style.strokeDashoffset = 62.8 * (1 - fillPct);
                
                if (kmh >= 1235) hudRpmBar.style.stroke = '#ff0055';
                else hudRpmBar.style.stroke = '#00f3ff';
            }

            if (kmh >= 1235 && !state.mach1 && !state.raceFinished) {
                state.mach1 = true;
                if (carWrapperElement) carWrapperElement.classList.add('supersonic-car');
                
                let currentPos = carMarker.getLatLng();
                const boomIcon = L.divIcon({ html: '<div class="sonic-boom"></div>', className: '', iconSize: [0,0] });
                const boomMarker = L.marker([currentPos.lat, currentPos.lng], {icon: boomIcon}).addTo(map);
                setTimeout(() => map.removeLayer(boomMarker), 600);

            } else if (kmh < 1200 && state.mach1) {
                state.mach1 = false;
                if (carWrapperElement) carWrapperElement.classList.remove('supersonic-car');
            }

            requestAnimationFrame(update);
        }

        requestAnimationFrame(update);

    </script>
</body>
</html>
